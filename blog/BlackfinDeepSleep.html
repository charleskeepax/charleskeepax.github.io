<!DOCTYPE html> <html> <head> <meta http-equiv="content-type" content="text/html; charset=utf-8"/> <meta http-equiv="content-language" content="en-gb"/> <meta name="language" content="english"/> <meta name="author" content="charles keepax"/> <meta name="robots" content="index, follow"/> <link rel="sitemap" href="/sitemap.xml" type="application/xml" title="Sitemap"/> <link rel="shortcut icon" href="/favicon.ico" type="image/vnd.microsoft.icon"/> <link rel="stylesheet" href="/styles/layout.css" type="text/css" media="screen"/> <link rel="stylesheet" href="/styles/m_layout.css" type="text/css" media="handheld, only screen and (max-device-width:480px)"/> <link rel="stylesheet" href="/styles/webblog.css" type="text/css" media="screen"/> <link rel="stylesheet" href="/styles/m_webblog.css" type="text/css" media="handheld, only screen and (max-device-width:480px)"/> <meta name="description" content="A guide on using the Analog Devices Blackfin DSP chips deep sleep mode."/> <meta name="keywords" content="charles keepax, charles, keepax, embedded,development,blackfin"/> <title>Blackfin Deep Sleep - Charles Keepax</title> </head> <body> <div> <div id="title_container"> <h1>Charles Keepax's Blog</h1> <a id="feedlink" href="/atom.xml"><img src="/image/rss.svg" height="16" width="16" alt="Atom Feed"/></a> </div> <div id="sidebar_background"></div> <div id="column_container"> <div id="sidebar_container"> <ul class="nav_list"> <li class="nav_item"><div><a href="/index.html"><img class="spicon" src="/image/calendar.svg" height="12" width="12"/>Blog</a></div></li> <li><ol id="blogposts_sidebar" class="nav_list"> <li class="nav_item"><div> <a href="/blog/WebsiteIcons.html">Website Icons</a> </div></li> <li class="nav_item"><div> <a href="/blog/KeypressesFromJoystick.html">Keypresses From Joystick</a> </div></li> <li class="nav_item"><div> <a href="/blog/IntelHEXChecksumsInVim.html">Intel HEX Checksums in Vim</a> </div></li> <li class="nav_item"><div> <a href="/blog/CPPForEmbedded.html">C++ for Embedded?</a> </div></li> <li class="nav_item"><div> <a href="/blog/UltimateChilliRecipe.html">Ultimate Chilli Recipe?</a> </div></li> <li class="nav_item"><div><a href="/blog/archive.html">Blog Archive</a></div></li> <li class="nav_item"><div><a href="/blog/tags.html">Blog Tags</a></div></li> </ol></li> <li class="nav_item"><div><a href="/cv.html"><img class="spicon" src="/image/doc.svg" height="12" width="12"/>Curriculum Vitae</a></div></li> <li><ol class="nav_list"> <li class="nav_item"><div><a href="/cv.html#cv_profile">Profile</a></div></li> <li class="nav_item"><div><a href="/cv.html#cv_employmenthistory">Employment History</a></div></li> <li class="nav_item"><div><a href="/cv.html#cv_education">Education</a></div></li> <li class="nav_item"><div><a href="/cv.html#cv_publications">Publications</a></div></li> <li class="nav_item"><div><a href="/cv.html#cv_references">References</a></div></li> </ol></li> <li class="nav_item"><div><a href="/links.html"><img class="spicon" src="/image/link.svg" height="12" width="12"/>Links</a></div></li> <li><ol class="nav_list"> <li class="nav_item"><div><a href="https://bitbucket.org/charleskeepax">Bitbucket</a></div></li> <li class="nav_item"><div><a href="http://github.com/charleskeepax">Github</a></div></li> <li class="nav_item"><div><a href="http://uk.linkedin.com/pub/charles-keepax/24/b79/59a">LinkedIn</a></div></li> <li class="nav_item"><div><a href="http://stackoverflow.com/users/735744/charles-keepax">Stackoverflow</a></div></li> </ol></li> <li class="nav_item"><div> <a href="mailto:&#99;&#107;&#101;&#101;&#112;&#97;&#120;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;"><img class="spicon" src="/image/email.svg" height="12" width="12"/>Contact</a> </div></li> </ul> </div> <div id="content_container"> <div class="section"> <h2>Blackfin Deep Sleep</h2> <div class="subsection"> <p>The Blackfin is a <abbr title="Digital Signal Processoring">DSP</abbr> chip from Analog Devices, today I shall go through one of its dynamic power management features, namely the deep sleep mode. The Blackfin provides four reduced power consumption modes of operation: active, sleep, deep sleep and hibernate. Deep sleep provides the second greatest power saving of the range. Hibernate provides the greatest power savings but also requires far more work to accomodate, as the processor's internal state is not preserved. I shall endeavour to cover hibernate another day, but if you are interested now there is a fairly good <a href="http://www.analog.com/static/imported-files/application_notes/EE-334_Rev1.pdf">hibernation application note</a> on the Analog Devices site.</p> <p>The deep sleep mode turns off both the internal clocks of the processor (the core clock and the peripheral clock) and powers down the <abbr title="Phase Locked Loop">PLL</abbr>. As such there are only two ways to wake the processor from deep sleep: a hardware reset or an <abbr title="Real-Time Clock">RTC</abbr> interrupt. The <abbr title="Real-Time Clock">RTC</abbr> has its own clock and thus can still function whilst the other clocks are stopped. If you are waking using a hardware reset the hibernation mode would also certainly make more sense than deep sleep so I shall only cover the <abbr title="Real-Time Clock">RTC</abbr> method in this post.</p> <p>If you have one of the evaluation boards for the Blackfin (the code here was run on a BF533 EZ-KIT Lite) and a copy of Visual DSP, I would recommend modifing the LED Blink (C) example project that is distributed with your copy of Visual DSP. It provides nice feedback, you can see the processor sleeping when the <abbr title="Light Emitting Diodes">LEDs</abbr> have temporarily ceased strobing.</p> <h3>Configuring the <abbr title="Real-Time Clock">RTC</abbr></h3> <p><script src="https://gist.github.com/709848.js?file=part1.c"></script></p> <p>Ok so before we can do any sleeping we are going to have to configure the <abbr title="Real-Time Clock">RTC</abbr>. The gist (thanks Github) above shows a general purpose RTC configuration. Firstly we turn the prescalar on by writing the appropriate bit in the RTC_PREN register. This tells the <abbr title="Real-Time Clock">RTC</abbr> to run at 1Hz, as initially it is running at the raw crystal frequency of 32.768Hz. Notice that we cleared the Write Complete bit in the RTC_ISTAT register and then waited until it is set again. With the exception of RTC_ISTAT, writes to all the <abbr title="Real-Time Clock">RTC</abbr> control registers are synchronised to the ticks of the <abbr title="Real-Time Clock">RTC</abbr> clock and as such do not complete very quickly. The RTC_ISTAT register contains some bits that allow us to keep tabs on these writes. The Write Pending bit is set whilst writes are in progress, once said writes are all complete the Write Complete bit is set. The Write Pending bit clears automatically when a write completes and its falling edge is what sets the Write Complete bit, however the Write Complete bit requires manual clearing. This like all bits in the RTC_ISTAT with the exception of Write Pending is cleared by writing a 1 to it. If you are not diligent in clearing or checking the Write Complete bit, a few nasty things can happen but the most relevant to us being entering sleep mode with a write still pending. This generally results in getting stuck in sleep mode, but lets just say that "scary strange behaviour" will result.</p> <p>The clock is now running at the right speed, next we need to set it up. Lets reset RTC_STAT, I shall not explain the encoding as it is covered perfectly well in the manual, but this holds the current time. Turn off the stopwatch (RTC_SWCNT), and deactivate all the interrupts (RTC_ICTL). The stopwatch counter is not cleared during a hardware reset and thus may contain any value, it consumes a small amount of additional power so it is good to zero it. Obviously, lets wait for these writes to complete, notice that we can happily write multiple registers in one go.</p> <p><script src="https://gist.github.com/709848.js?file=part3.c"></script></p> <p>With the <abbr title="Real-Time Clock">RTC</abbr> running nice and normally lets set it up for use to wake the processor from deep sleep. A few things are going on here firstly, we configure the <abbr title="Real-Time Clock">RTC</abbr> with function we just wrote and then wait for 5 seconds. Wait... what? Why? Well your <abbr title="Joint Test Action Group">JTAG</abbr> connection to the processor is lost when the processor enters deep sleep. This makes it rather hard to debug sleep applications and generally the program must be loaded onto whatever the system would normally run from, flash in the case of our BF533 EZ-KIT Lite. Now whilst playing with the sleep modes you will invariably managed to create a few programs that enter sleep mode and never return, now the processor can boot from flash rather quickly and if you can't connect with the <abbr title="Joint Test Action Group">JTAG</abbr> to reprogram you have a problem. There are a few ways out of this hole once in it but far more convient just to put a small delay during the boot of the processor so you can reset and connect with the <abbr title="Joint Test Action Group">JTAG</abbr>, at least until you have your code working smoothly. If you do get stuck, you probably have two options a direct connection to the flash and reprogramming or erasing, if this is supported, or as a backup prevent the processor from booting from flash (i.e. disconnect it, force a chip select low, etc.).</p> <p>Anyway getting back on track, next we configure the <abbr title="Real-Time Clock">RTC</abbr> to trigger an appropriate event. In our case the event is a stopwatch interrupt in 5 seconds time. The 5 seconds goes into RTC_SWCNT and we set the enable for the stopwatch interrupt in RTC_ICTL. Of course we then need to wait for this write to complete, which will happen at the next 1Hz tick, this is worth remembering when using the stopwatch as you can end up waiting slightly longer than you expect to. If you program 5 seconds in you have 5 seconds plus upto 1 second of register writing time until the event actually triggers.</p> <p>Now the astute amoung you will have notice that we cleared significantly more than just Write Complete when we wrote RTC_ISTAT; if we enter deep sleep with our choosen wake up event set in RTC_ISTAT already set, which it is in our case from the write of zero we did during initialisation, we once again stray into "scary strangle behaviour" land. Avoiding this problem is pretty easy with the stopwatch or alarm, simply clear the flag and enter sleep before the timer you set expires.</p> <p>If you are adding this code into the LED Blink (C) project, the previous gist should be placed just before the infinite while loop in the main function.</p> <h3>Bed Time</h3> <p><script src="https://gist.github.com/709848.js?file=part2.c"></script></p> <p>Entering deep sleep is a simple matter of writing a 1 to the PWDN bit in the PLL_CTL register, then performing a <abbr title="Phase Locked Loop">PLL</abbr> programming sequence. We then just wait in our deep sleep until the RTC fires its wake up event and restarts the process. A <abbr title="Phase Locked Loop">PLL</abbr> programming sequence is a fancy way of staying issuing an idle instruction with the interrupts disabled. We can disable and enable the interrupts with the builtin functions cli and sti, idle is provided with the builtin function idle.</p> <p>The only slight complication is that once we awake from deep sleep we awake in active mode rather than normal operation. In active mode the <abbr title="Phase Locked Loop">PLL</abbr> is bypassed, in short the clock speed is a lot slower. To return to normal operation we need to clear the bypass bit in the PLL_CTL register and then perform another <abbr title="Phase Locked Loop">PLL</abbr> programming sequence.</p> <p>Congratulations, we have managed to sleep and wake up again.</p> <h3>Alarm Clock</h3> <p><script src="https://gist.github.com/709848.js?file=part4.c"></script></p> <p>Using the alarm, which matches a specific time rather than just a countdown like the stopwatch, is very simple. We use the RTC_ALARM register instead of RTC_SWCNT and enable the alarm interrupt event. The RTC_ALARM register represents a time in the same way as RTC_STAT, with bit fields for the days, hours, minutes and seconds. If in the unlikely event you want to wake up on a specific day as well as time you must use the day event rather than the alarm event. The alarm event only matches the hours, minutes and seconds between the two registers.</p> <h3>1Hz Wakeup</h3> <p><script src="https://gist.github.com/709848.js?file=part5.c"></script></p> <p>The <abbr title="Real-Time Clock">RTC</abbr> also has a 1Hz tick which can be used to wake up. The primary thing you will notice about the gist for this one is that we clear RTC_ISTAT again after the write has completed. This is because the write completes on the 1Hz tick which also sets the event in the register and as before if we enter deep sleep with the event already trigger chances are we are not waking up again. Indeed care must in general to ensure that there is no possibility of the tick occuring between the point you clear the RTC_ISTAT register and when you enter sleep.</p> <h3>The End</h3> <p>So I think we can probably condense this post into a few golden rules of deep sleep:</p> <p><ol> <li>Always clear the Write Complete bit before doing a write to the <abbr title="Real-Time Clock">RTC</abbr> registers.</li> <li>Never enter sleep mode with your wakeup event already set in RTC_ISTAT.</li> <li>Leave a small pause at the start of your code for <abbr title="Joint Test Action Group">JTAG</abbr> testing purposes, at least while developing.</li> </ol></p> <p>Well thats probably enough for one post, it kinda ballooned from small chat about deep sleep into a full blow tutorial. I hope it helped someone out there.</p> <div class="bp_footer"> <span class="rnote">Posted by <span class="bp_name">Charles Keepax</span> on <span class="bp_date">24/11/2010</span></span> <span class="bp_tags"> <img class="spicon" src="/image/tag.svg" height="16" width="16" alt="tags:"/> <a href="/blog/tags.html#bar_embedded">embedded</a> <a href="/blog/tags.html#bar_development">development</a> <a href="/blog/tags.html#bar_blackfin">blackfin</a> </span> </div> </div> </div> </div> <div id="footer_spacer"></div> </div> <div id="footer_container"> <p>Copyright &copy; Charles Keepax 2010-2022. All rights reserved. </div> </div> </body> </html>